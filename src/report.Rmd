---
title: "NYC Flights Delays"
author: "Turki Alsaedi, Saad AlOtaibi, Yousef Alotaibi, Maan Al Neami, Shaimaa Alghamdi<br><br> Table of Contents"
output:
  html_document:
    df_print: paged
    toc: true
editor_options:
  chunk_output_type: inline
---
```{=html}
<style>
#caption{
    color: #777777;
}
body {
text-align: justify;
max-width: 800px;
margin: auto;
font-size: 16px;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,    # hide code blocks
                      message = FALSE) # hide warning messages
library(here)
library(tidyverse)
library(knitr)
library(nycflights13)
library(plotly)
library(ggplot2)
```

### Introduction
Airport delays are one of the most common problems people face upon travelling. These delays are usually associated with certain carriers or destinations. Thus the question is, are they really the cause of these delays or is it due to other reasons?

In 2013, data about 336,776 flights were collected to answer this question, the data collected were about flights departing from New York City across all of its airports: John F. Kennedy International Airport (JFK), Newark Liberty International Airport (EWR) and LaGuardia Airport (LGA) to destinations all over the United States and some of its territories (Puerto Rico, and the American Virgin Islands). The data was described by 19 attributes shown in Table 1.

#### Goal

#### Methods

### EDA
#### The Dataset

```{r}
flights_data <- read.csv(here("data/flights_data_v2.csv"))

kable(flights_data)
```
<p id="caption">Table 1: A list of all attributes and its descriptions that are present in the dataset</p>

<br>
Although 3 airports per city may seem large, larger than many of the world’s capitals, the city that never sleeps hosts only 3 out of 16 airports of the state of New York which itself is not the host of the largest number of airports per state as shown in Figure 1.

<br><br>

```{r}
airports_per_state <- read_csv(here("data/airports_per_state.csv"))

airports_per_state %>% 
  group_by(state, state_abv) %>% 
  summarise(airports_no = n()) -> airports_per_state

# Plotting the map

fig <- plot_geo(airports_per_state, locationmode = 'USA-states')

# specifying scale and options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

fig %>%
  add_trace(
    z = ~airports_no, text = ~state, locations = ~state_abv,
    color = ~airports_no, colors = 'Purples') %>% 
  colorbar(title = "Airports") %>%
  layout( title = 'No. of airports per State',
          geo = g)
```
<p id="caption">Figure 1: An interactive map showing the number of airports per state. Puerto Rico (7 airports) and U.S. Virgin Islands (2 airports) are not shown.</p>

<br>
Based on the figure we can observe that:

- Alaska has 28 airports making it the state with the largest number of airports followed by Texas (24) and California (23).
- Only one state (Vermont) has one airport.
- Every state has at least one airport.

The three airports of the city of New York serve different purposes–such as domestic or international–and hence should have different number of flights, let us confirm that using Figure 2.

```{r}
flights %>% 
  group_by(origin) %>% 
  summarise(count_flights = n()) %>% # % of flights
  ggplot(aes(x= origin, y = count_flights)) +
           geom_col()
```
<p id="caption">Figure 2: An interactive map showing the number of airports per state. Puerto Rico (7 airports) and U.S. Virgin Islands (2 airports) are not shown.</p>


### Conclusion
### Resources
### Source Code


##### MAAN

##### SAAD

##### YOSUF
```{r, echo=FALSE, include=FALSE}
flights -> flights_df
glimpse(flights_df)
summary(flights_df)

# Checking for duplicates.
janitor::get_dupes(flights_df)

# Checking for null values.
flights_df <- flights_df %>% drop_na()
colSums(is.na(flights_df))

```

```{r, figures-side, fig.show="hold", out.width="50%"} 
# library("gridExtra")  

flights_df1 <- flights_df

# Categorizing the dep_delay & arr_delay time into 5 categories 

flights_df1$dep_delay_cat <- cut(flights_df1$dep_delay,
                     breaks = c(-45,-1,0,15,60,1301),
                     labels = c("Before Time",
                                "On Time",
                                "Low Delay (less than 15 min)",
                                "Medium Delay (16-60 min)",
                                "High Delay (more than 60 min)"))

flights_df1$arr_delay_cat <- cut(flights_df1$arr_delay,
                     breaks = c(-88,-1,0,15,60,1272),
                     labels = c("Before Time",
                                "On Time",
                                "Low Delay (less than 15 min)",
                                "Medium Delay (16-60 min)",
                                "High Delay (more than 61 min)"))

# Plotting dep_delay_cat and arr_delay_cat based on it's count in the year
# 2013, so we can know how much each represent in our sample.

ggplot(flights_df1, aes(dep_delay_cat)) +
  geom_bar(fill = "cadetblue3") +
  geom_text(aes(label= scales::percent(after_stat(as.double(prop))), group=1),
            stat='count', vjust = -0.3,) +
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  labs(title="Percentage of NYC Flights Departure Delay (2013)",
       x = "Departue Delay Time",
       y = "Number of Departure Delays")


ggplot(flights_df1, aes(arr_delay_cat)) +
  geom_bar(fill = "cadetblue3") +
  geom_text(aes(label= scales::percent(after_stat(as.double(prop))), group=1),
            stat='count', vjust = -0.3, ) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  labs(title="Percentage of NYC Flights Arrival Delay (2013)",
       x = "Arrival Delay Time",
       y = "Number of Arrival Delays")

# grid.arrange(dep_plot, arr_plot, ncol = 2)

``` 

#### We can see that almost 39% of the NYC flights in the year 2013 had a departure delay, only 5% departed on time and 55.9% departed before time.
#### as for the arrival delays, we can see that it doesn't differ that much from the departure delays.

<br><br>

```{r, echo=FALSE} 

# Summarizing each carrier with no_flights and percentage of dep_delays.

flights_df1 %>% 
  group_by(carrier) %>%
  summarise(no_flights = n(), 
            low_delay = scales::percent(sum(dep_delay > 0 & dep_delay < 16)/no_flights),
            medium_delay = scales::percent(sum(dep_delay > 16 & dep_delay < 61)/no_flights),
            high_delay = scales::percent(sum(dep_delay > 60)/no_flights),
            overall_delay = scales::percent(sum(dep_delay > 0)/no_flights)) %>%
  arrange(-no_flights)
```
#### WN carriers tend to have the highest percentage of overall delays, and US carriers tend to have a low percentage of delays compared to its number of flights.

<br><br>
```{r, echo=FALSE}

# Plotting each carrier based on dep_delay_cat

flights_pos_delay <- flights_df1 %>%
  filter(dep_delay > -1)

ggplot(flights_pos_delay, aes(y = carrier, fill = dep_delay_cat)) +
  geom_bar()
```
#### From the horizontal stacked bar it's clear that carriers UA, EV, B6 and DL have the highest frequency of delays, also these carriers have the highest number of flights, which can tell us that carriers having a high amount of flights tend to have a high frequency of delays.

<br><br>
```{r, echo=FALSE}

# Summarizing each carrier with highest_delay and avg_delay

flights_df1 %>%
  group_by(carrier) %>%
  summarise(highest_delay = max(dep_delay), avg_delay = mean(dep_delay)) %>%
  arrange(-avg_delay)
 
```
#### The carrier with the highest delay time is HA with 1301 min delay and the carrier with the highest avg delay is F9 with an average of 20.2 

##### SHAIMAA
