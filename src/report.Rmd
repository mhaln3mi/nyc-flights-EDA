---
title: "NYC Flights Delays"
author: "Turki Alsaedi, Saad AlOtaibi, Yousef Alotaibi, Maan Al Neami, Shaimaa Alghamdi<br><br> Table of Contents"
output:
  html_document:
    df_print: paged
    toc: true
editor_options:
  chunk_output_type: inline
---
```{=html}
<style>
#caption{
    color: #777777;
}
body {
text-align: justify;
max-width: 800px;
margin: auto;
font-size: 16px;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,    # hide code blocks
                      message = FALSE) # hide warning messages
library(here)
library(tidyverse)
library(knitr)
library(nycflights13)
library(plotly)
library(ggplot2)
```

### Introduction
Airport delays are one of the most common problems people face upon travelling. These delays are usually associated with certain carriers or destinations. Thus the question is, are they really the cause of these delays or is it due to other reasons?

In 2013, data about 336,776 flights were collected to answer this question, the data collected were about flights departing from New York City across all of its airports: John F. Kennedy International Airport (JFK), Newark Liberty International Airport (EWR) and LaGuardia Airport (LGA) to destinations all over the United States and some of its territories (Puerto Rico, and the American Virgin Islands). The data was described by 19 attributes shown in Table 1.

#### Goal
In this report, our goal is to alanyze the dataset to find relationships between delays and our variables.
<br>
#### Methods
-Data munging
-Exploratory data analysis(EDA)
-Data visualization
<br>
### EDA
#### The Dataset

```{r}
flights_data <- read.csv(here("data/flights_data_v2.csv"))

kable(flights_data)
```
<p id="caption">Table 1: A list of all attributes and its descriptions that are present in the dataset</p>

<br>
Although 3 airports per city may seem large, larger than many of the world’s capitals, the city that never sleeps hosts only 3 out of 16 airports of the state of New York which itself is not the host of the largest number of airports per state as shown in Figure 1.

<br><br>

```{r}
airports_per_state <- read_csv(here("data/airports_per_state.csv"))

airports_per_state %>% 
  group_by(state, state_abv) %>% 
  summarise(airports_no = n()) -> airports_per_state

# Plotting the map

fig <- plot_geo(airports_per_state, locationmode = 'USA-states')

# specifying scale and options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

fig %>%
  add_trace(
    z = ~airports_no, text = ~state, locations = ~state_abv,
    color = ~airports_no, colors = 'Purples') %>% 
  colorbar(title = "Airports") %>%
  layout( title = 'No. of airports per State',
          geo = g)
```

<p id="caption">Figure 1: An interactive map showing the number of airports per state. Puerto Rico (7 airports) and U.S. Virgin Islands (2 airports) are not shown.</p>

<br>
Based on the figure we can observe that:

- Alaska has 28 airports making it the state with the largest number of airports followed by Texas (24) and California (23).
- Only one state (Vermont) has one airport.
- Every state has at least one airport.

The three airports of the city of New York serve different purposes–such as domestic or international–and hence should have different number of flights, let us confirm that using Figure 2.

```{r}
flights %>% 
  group_by(origin) %>% 
  summarise(count_flights = n()) %>% # % of flights
  ggplot(aes(x= origin, y = count_flights)) +
           geom_col()
```
<p id="caption">Figure 2: An interactive map showing the number of airports per state. Puerto Rico (7 airports) and U.S. Virgin Islands (2 airports) are not shown.</p>


### Conclusion
### Resources
### Source Code


##### MAAN

``` {r, figures-side, fig.show="hold", out.width="50%"}

flights_df %>%
  filter(dep_delay > 0) %>%
  count(month, dep_delay) %>% 
  ggplot(aes(month, n)) +
  geom_col() +
  labs(x = "Month",
       y = "Number of Departure delays",
       title = "Number of Departure delays by month") +
  xlim(0,12.5)

flights_df %>%
  filter(arr_delay > 0) %>%
  count(month, arr_delay) %>% 
  ggplot(aes(month, n)) +
  geom_col() +
  labs(x = "Month",
    y = "Number of Arrival delays",
    title = "Number of Arrival delays by month") +
  xlim(0,12.5)
```

<br>

We can see from the first plot on the left that the highest number of departure delays occur on month 6 (Jun), 7 (Jul), and 12 (Dec), which indicate there are more departure delays during summer and winter breaks.

<br>
similar to the previous plot, in the second plot on the right, we see highest number of arrival delays occur on month 7 (Jul), and 12 (Dec) during the summer and winter breaks.

<br>



```{r figures-side, fig.show="hold", out.width="50%"}
flights_df %>%
  count(month, dep_delay, flight) %>% 
  ggplot(aes(as.factor(month), fill = (dep_delay > 0))) +
  geom_bar(position = "stack") +
  labs(x = "Month",
       y = "Number of Flights",
       title = "Number of flights by month") +
  guides(fill = guide_legend("Departure Delay"))

flights_df %>%
  count(month, arr_delay, flight) %>% 
  ggplot(aes(as.factor(month), fill = (arr_delay > 0))) +
  geom_bar(position = "stack") +
  labs(x = "Month",
       y = "Number of Flights",
       title = "Number of flights by month") +
  guides(fill = guide_legend("Arrival Delay"))
```

<br>

In the first plot on the left, we can see that as the number of flights increases, the number of departure delays also increase.
If we check for the months with the highest delays, 6 (Jun), 7 (Jul), and 12 (Dec). We see they also have the highest 
number of flights compared to other months. 
<br>
The second plot is similar to the first where the number of flights increases, the number of Arrival delays also increase. Except that for month 8 (Aug), where the number of flights were high but the arrival delays were relatively lower than months with less flights.

<br>

```{r}
all_df <- subset(flights, 
                 select = c(dep_time, sched_dep_time, dep_delay,
                            arr_time, sched_arr_time, arr_delay,
                            air_time, distance) )

all_matrix <- cor(all_df, use = "complete.obs")

library(corrplot)
corrplot(all_matrix, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45, diag = FALSE, method = "number")
```

<br>

Here we see the correlation matrix between the main numeric attributes.

- Surprisingly there is no correlation at all between distance and the delays which was the opposite of what we expected.
- there is no correlation between air time and the delays.
- there is a *strong* correlation between departure delay and arrival delay which is reasonable since one usually is caused by the other.
- there is some obvious *strong* correlations like between the distance and the air time and the bottom part between the attributes departure time, scheduled departure time, arrival time, scheduled arrival time.

##### YOSUF

##### SHAIMAA
